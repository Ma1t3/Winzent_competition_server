{% extends 'base.html' %}
{% load static %}

{% block title %}Competition {{ competition.name }} | PG-ASC Competition Server{% endblock %}

{% block custom_style %}
    <link href="{% static 'css/lists.css' %}" rel=stylesheet>
    <style>
        .overflow-auto {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container p-5">
        <div class="row">
            <div class="d-flex" style="flex-basis:80%;">
                <h1>Competition: {{ competition.name }}{% if competition.is_public == True %}
                    <i class="bi bi-globe2"></i>
                {% endif %}</h1>
            </div>
            {% if user.is_authenticated %}

                <div class="d-flex" style="flex-basis:20%; justify-content: flex-end; align-items: flex-start">

                    <!-- Option-Dropdown-Menu -->
                    <div class="dropdown">
                        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown"
                                aria-expanded="false">
                            Options
                        </button>

                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item"
                                   href="{% url 'competitiondefinitionmanagement:download' competition.id %}">
                                    Download Competition Run Document
                                </a>
                            </li>

                            <li>
                                <a class="dropdown-item {% if competition.status != 'completed' %}disabled{% endif %}"
                                   href="{% url 'competitiondefinitionmanagement:export-results' competition.id %}">
                                    Export Results
                                </a>
                            </li>

                            <li>
                                <a class="dropdown-item"
                                   href="{% url 'competitiondefinitionmanagement:competitioncopy' competition.id %}">
                                    Duplicate Competition
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Tab-Bar -->
        <div class="container p-3">
            <div class="row" style="margin-top: 20px;">
                <nav>
                    <div class="nav nav-tabs" id="nav-tab" role="tablist">
                        <button class="nav-link active" id="nav-parameters-tab" data-bs-toggle="tab"
                                data-bs-target="#nav-parameters"
                                type="button" role="tab" aria-controls="nav-parameters" aria-selected="true">Summary
                        </button>

                        <button class="nav-link" id="nav-crd-tab" data-bs-toggle="tab"
                                data-bs-target="#nav-crd"
                                type="button" role="tab" aria-controls="nav-crd" aria-selected="false">
                            Competition Run Document
                        </button>

                        <button class="nav-link" id="nav-experiments-tab" data-bs-toggle="tab"
                                data-bs-target="#nav-experiments"
                                type="button" role="tab" aria-controls="nav-experiments" aria-selected="false">
                            Experiments
                        </button>

                        <button class="nav-link " id="nav-results-defender-tab" data-bs-toggle="tab"
                                data-bs-target="#nav-results-defender"
                                type="button" role="tab" aria-controls="nav-results-defender" aria-selected="false">
                            Defender Results
                        </button>

                        <button class="nav-link " id="nav-leaderboard-defender-tab" data-bs-toggle="tab"
                                data-bs-target="#nav-leaderboard-defender"
                                type="button" role="tab" aria-controls="nav-leaderboard-defender" aria-selected="false">
                            Defender Leaderboard
                        </button>

                        <button class="nav-link " id="nav-results-attacker-tab" data-bs-toggle="tab"
                                data-bs-target="#nav-results-attacker"
                                type="button" role="tab" aria-controls="nav-results-attacker" aria-selected="false">
                            Attacker Results
                        </button>

                        <button class="nav-link " id="nav-leaderboard-attacker-tab" data-bs-toggle="tab"
                                data-bs-target="#nav-leaderboard-attacker"
                                type="button" role="tab" aria-controls="nav-leaderboard-attacker" aria-selected="false">
                            Attacker Leaderboard
                        </button>
                    </div>
                </nav>
            </div>


            <div class="row">
                <div class="tab-content" id="nav-tabContent">
                    <!-- Tab: Summary -->
                    <div class="tab-pane fade show active" id="nav-parameters" role="tabpanel"
                         aria-labelledby="nav-parameters-tab">
                        <div class="row" style="margin-top: 20px; margin-left: 15px;">
                            <h3>Competition-Details</h3>
                        </div>
                        <div class="row" style="margin-top: 20px;">
                            <div class="d-flex" style="flex-basis:20%; justify-content: flex-end;">
                                Name:
                            </div>
                            <div class="d-flex" style="flex-basis:80%; text-align: left;">
                                {{ competition.name }}
                            </div>
                        </div>
                        <div class="row" style="margin-top: 20px;">
                            <div class="d-flex" style="flex-basis:20%; justify-content: flex-end;">
                                Status:
                            </div>
                            <div class="d-flex" style="flex-basis:80%; text-align: left;">
                                {{ competition.status }}
                            </div>
                        </div>
                        <div class="row" style="margin-top: 20px;">
                            <div class="d-flex" style="flex-basis:20%; justify-content: flex-end;">
                                Owner:
                            </div>
                            <div class="d-flex" style="flex-basis:80%; text-align: left;">
                                {% if user.is_authenticated and user == competition.owner %} <i>you</i>
                                {% else %} {{ competition.owner.username }}
                                {% endif %}
                            </div>
                        </div>

                        <div class="row" style="margin-top: 20px;">
                            <!-- -->
                            <div class="d-flex" style="flex-basis:20%; justify-content: flex-end;">
                                Attacker:
                            </div>
                            <div class="d-flex" style="flex-basis:80%; text-align: left;">
                                <ul>
                                    {% for attacker in attackers %}
                                        <li>
                                            {% if user.id == attacker.owner_id or attacker.is_public == True %}
                                                <a href="{% url 'pgasc.web.agentsystemmanagement:agent_detail' attacker.id %}"
                                                   style="color: black; text-decoration: none;">
                                                    {{ attacker.name }}
                                                    {% if attacker.is_public == True %}
                                                        <i class="bi bi-globe2"></i>
                                                    {% endif %}
                                                </a>
                                            {% else %}
                                                <div class="text-muted"> {{ attacker.name }}</div>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>

                        <div class="row" style="margin-top: 20px;">
                            <div class="d-flex" style="flex-basis:20%; justify-content: flex-end;">
                                Defender:
                            </div>
                            <div class="d-flex" style="flex-basis:80%; text-align: left;">
                                <ul>
                                    {% for defender in defenders %}
                                        <li>
                                            <a href="{% url 'pgasc.web.agentsystemmanagement:agent_detail' defender.id %}"
                                               style="color: black; text-decoration: none;">
                                                {{ defender.name }}
                                                {% if defender.is_public == True %}
                                                    <i class="bi bi-globe2"></i>
                                                {% endif %}
                                            </a>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Competition Run Document -->
                    <div class="tab-pane fade" id="nav-crd" role="tabpanel" aria-labelledby="nav-crd-tab">
                        <div class="row" style="margin-top: 20px; margin-left: 15px;">
                            <h3>Competition Run Document</h3>
                        </div>
                        <div class="row" style="margin-left: 15px; margin-right: 15px;">
                            <div class="row vh-100">
                                <pre class="h-100 w-100"><code class="language-yaml">{{ competition.erd }}</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Experiments -->
                    <div class="tab-pane fade" id="nav-experiments" role="tabpanel"
                         aria-labelledby="nav-experiments-tab" style="background: #eee">
                        <div class="row" style="padding-left: 15px; padding-right: 15px;">
                            {% include 'experiment_list.html' %}
                        </div>
                    </div>

                    <!-- Tab: Results Defender -->
                    <div class="tab-pane fade" id="nav-results-defender" role="tabpanel"
                         aria-labelledby="nav-results-defender-tab">
                        <div class="row" style="margin-top: 20px; margin-left: 15px;">
                            <h3>Defender Results</h3>
                            <div>
                                {% if competition_results_defender %}
                                    {% for criteria, results in competition_results_defender.items %}
                                        <h4>{{ criteria }}</h4>
                                        <table class="table table-striped table-hover">
                                            <colgroup>
                                                <col span="1" style="width: 40%">
                                                <col span="3" style="width: 20%"/>
                                            </colgroup>
                                            <thead>
                                            <tr>
                                                <th>Agent</th>
                                                <th>Average</th>
                                                <th>Minimum</th>
                                                <th>Maximum</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {% for agent, avg_value, min_value, max_value, unit in results %}
                                                <tr>
                                                    <td>
                                                        {% if user.id == agent.owner_id or agent.is_public == True %}
                                                            <a href="{% url 'pgasc.web.agentsystemmanagement:agent_detail' agent.id %}">
                                                                {{ agent.name }}
                                                            </a>
                                                        {% else %}
                                                            {{ agent.name }}
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ avg_value|stringformat:".2f" }} {{ unit }}</td>
                                                    <td>{{ min_value|stringformat:".2f" }} {{ unit }}</td>
                                                    <td>{{ max_value|stringformat:".2f" }} {{ unit }}</td>
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    {% endfor %}
                                    <div class="p-2">Values are rounded to 2 decimal places.</div>
                                {% else %}
                                    <div>
                                        <h6>Results are created only for finished competitions with at least one
                                            completed experiment.</h6>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Leaderboard Defender -->
                    <div class="tab-pane fade" id="nav-leaderboard-defender" role="tabpanel"
                         aria-labelledby="nav-leaderboard-defender-tab">
                        <div class="row" style="margin-top: 20px; margin-left: 15px;">
                            <h3>Defender Leaderboard</h3>
                            {% if leaderboard_list_defender %}
                                <ol class="list-group list-group-numbered">
                                    {% for agent, points in leaderboard_list_defender %}
                                        <li class="list-group-item d-flex"
                                            style="margin-bottom: 0">
                                            <div class="ps-2 flex-fill">
                                                {% if user.id == agent.owner_id or agent.is_public == True %}
                                                    <a href="{% url 'pgasc.web.agentsystemmanagement:agent_detail' agent.id %}">
                                                        {{ agent.name }}
                                                    </a>
                                                {% else %}
                                                    {{ agent.name }}
                                                {% endif %}
                                            </div>
                                            <div>{{ points|stringformat:".2f" }} Points</div>
                                        </li>
                                    {% endfor %}
                                </ol>
                                <div class="p-2">The ranking is created using the average values of the rating
                                    function (displayed rounded to 2 decimal places; descending for defenders). <br>
                                    The maximum achievable value of the rating function is 3400 Points.
                                </div>
                            {% else %}
                                <h6>The leaderboard is created only for finished competitions with at least one
                                    completed experiment.</h6>
                            {% endif %}

                        </div>
                    </div>

                    <!-- Tab: Results Attacker -->
                    <div class="tab-pane fade" id="nav-results-attacker" role="tabpanel"
                         aria-labelledby="nav-results-attacker-tab">
                        <div class="row" style="margin-top: 20px; margin-left: 15px;">
                            <h3>Attacker Results</h3>
                            <div>
                                {% if competition_results_attacker %}
                                    {% for criteria, results in competition_results_attacker.items %}
                                        <h4>{{ criteria }}</h4>
                                        <table class="table table-striped table-hover">
                                            <colgroup>
                                                <col span="1" style="width: 40%">
                                                <col span="3" style="width: 20%"/>
                                            </colgroup>
                                            <thead>
                                            <tr>
                                                <th>Agent</th>
                                                <th>Average</th>
                                                <th>Minimum</th>
                                                <th>Maximum</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {% for agent, avg_value, min_value, max_value, unit in results %}
                                                <tr>
                                                    <td>
                                                        {% if user.id == agent.owner_id or agent.is_public == True %}
                                                            <a href="{% url 'pgasc.web.agentsystemmanagement:agent_detail' agent.id %}">
                                                                {{ agent.name }}
                                                            </a>
                                                        {% else %}
                                                            {{ agent.name }}
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ avg_value|stringformat:".2f" }} {{ unit }}</td>
                                                    <td>{{ min_value|stringformat:".2f" }} {{ unit }}</td>
                                                    <td>{{ max_value|stringformat:".2f" }} {{ unit }}</td>
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    {% endfor %}
                                    <div class="p-2">Values are rounded to 2 decimal places.</div>
                                {% else %}
                                    <div>
                                        <h6>Results are created only for finished competitions with at least one
                                            completed experiment.</h6>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Leaderboard Attacker-->
                    <div class="tab-pane fade" id="nav-leaderboard-attacker" role="tabpanel"
                         aria-labelledby="nav-leaderboard-attacker-tab">
                        <div class="row" style="margin-top: 20px; margin-left: 15px;">
                            <h3>Attacker Leaderboard</h3>
                            {% if leaderboard_list_attacker %}
                                <ol class="list-group list-group-numbered">
                                    {% for agent, points in leaderboard_list_attacker %}
                                        <li class="list-group-item d-flex"
                                            style="margin-bottom: 0">
                                            <div class="ps-2 flex-fill">
                                                {% if user.id == agent.owner_id or agent.is_public == True %}
                                                    <a href="{% url 'pgasc.web.agentsystemmanagement:agent_detail' agent.id %}">
                                                        {{ agent.name }}
                                                    </a>
                                                {% else %}
                                                    {{ agent.name }}
                                                {% endif %}
                                            </div>
                                            <div>{{ points|stringformat:".2f" }} Points</div>
                                        </li>
                                    {% endfor %}
                                </ol>
                                <div class="p-2">The ranking is created using the average values of the rating
                                    function (displayed rounded to 2 decimal places; ascending for attackers). <br>
                                    The minimum achievable value of the rating function is 0 Points.
                                </div>
                            {% else %}
                                <h6>The leaderboard is created only for finished competitions with at least one
                                    completed experiment.</h6>
                            {% endif %}

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block js_block %}
    <script type="application/javascript" src="{% static 'javascript/export_data.js' %}" defer></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script type="application/javascript" src="{% static 'javascript/preserve_active_tab_on_reload.js' %}"
            defer></script>
    <script>
        $(document).ready(function () {
            preserveActiveTabOnReload();
        });
    </script>
{% endblock %}